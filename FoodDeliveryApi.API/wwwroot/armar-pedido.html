<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Armar Pedido</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; }
        .container { max-width: 900px; margin: 30px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 30px 40px 40px 40px; }
        h1, h2 { color: #2c3e50; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th, td { border: 1px solid #bfc9d1; padding: 8px 10px; text-align: left; }
        th { background: #eaf1fb; }
        tr:nth-child(even) { background: #f8f8f8; }
        .btn { background: #3498db; color: #fff; border: none; border-radius: 5px; padding: 7px 14px; cursor: pointer; transition: background 0.2s; }
        .btn:hover { background: #217dbb; }
        .section { margin-bottom: 35px; }
        .form-group { margin-bottom: 12px; }
        input, select { padding: 7px 10px; border-radius: 5px; border: 1px solid #bfc9d1; font-size: 1em; }
        input:focus, select:focus { outline: 2px solid #3498db; }
        pre { background: #f8f8f8; border-left: 4px solid #3498db; padding: 10px; border-radius: 5px; color: #333; }
    </style>
</head>
<body>
<div class="container">
    <h1>Armar Pedido</h1>
    <div class="section">
        <h2>Seleccionar Empresa</h2>
        <select id="empresaSelect"></select>
    </div>
    <div class="section">
        <h2>Seleccionar Productos</h2>
        <table id="tablaProductos">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Adicionales</th>
                    <th>Agregar</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <h3>Detalle del Pedido</h3>
        <ul id="detallePedido"></ul>
        <div><b>Total: $<span id="totalPedido">0.00</span></b></div>
    </div>
    <div class="section">
        <h2>Finalizar Pedido</h2>
        <form id="formFinalizarPedido">
            <div class="form-group">
                <label>Método de Pago:</label>
                <input type="text" id="metodoPago" required>
            </div>
            <div class="form-group">
                <label>Tipo de Entrega:</label>
                <select id="tipoEntrega">
                    <option value="Domicilio">Domicilio</option>
                    <option value="ParaLlevar">Para Llevar</option>
                    <option value="EnLocal">En Local</option>
                </select>
            </div>
            <div class="form-group">
                <label>Dirección (ID, opcional):</label>
                <input type="number" id="idDireccionCliente">
            </div>
            <button type="submit" class="btn">Enviar Pedido</button>
        </form>
        <pre id="respuestaPedido"></pre>
    </div>
</div>
<script>
    // Variables globales
    let idCliente = localStorage.getItem('idCliente');
    console.log('idCliente desde localStorage:', idCliente);
    let productosEmpresa = [];
    let detalle = [];
    let total = 0;
    // Cargar empresas
    async function cargarEmpresas() {
        const res = await fetch('http://localhost:5012/api/Empresas');
        const empresas = await res.json();
        const select = document.getElementById('empresaSelect');
        select.innerHTML = '';
        empresas.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.idEmpresa;
            opt.textContent = e.nombre;
            select.appendChild(opt);
        });
        if (empresas.length > 0) cargarProductos(empresas[0].idEmpresa);
    }
    document.getElementById('empresaSelect').addEventListener('change', function() {
        cargarProductos(this.value);
        detalle = [];
        total = 0;
        actualizarDetalle();
    });
    // Cargar adicionales de la empresa seleccionada
    let adicionalesEmpresa = [];
    async function cargarAdicionales(idEmpresa) {
        const res = await fetch('http://localhost:5012/api/Adicionales/empresa/' + idEmpresa);
        let adicionales = await res.json();
        if (!Array.isArray(adicionales)) {
            adicionales = [];
        }
        adicionalesEmpresa = adicionales;
    }

    // Cargar productos de la empresa seleccionada
    async function cargarProductos(idEmpresa) {
        await cargarAdicionales(idEmpresa);
        const res = await fetch('http://localhost:5012/api/Producto/idempresa/' + idEmpresa);
        let productos = await res.json();
        if (!Array.isArray(productos)) {
            productos = [];
        }
        productosEmpresa = productos;
        const tbody = document.getElementById('tablaProductos').querySelector('tbody');
        tbody.innerHTML = '';
                productosEmpresa.forEach(p => {
                        let adicionalesHtml = '';
                        if (adicionalesEmpresa.length > 0) {
                                // Selector para elegir entera o mitad
                                adicionalesHtml = `
                                <div id='tipoPizza_${p.idProducto}'>
                                    <label><input type='radio' name='tipo_${p.idProducto}' value='entera' checked> Entera</label>
                                    <label><input type='radio' name='tipo_${p.idProducto}' value='mitad'> Mitad</label>
                                </div>
                                <div id='adicionales_entera_${p.idProducto}'>
                                    <label style='font-size:0.9em'>Adicionales:</label>
                                    <select multiple id='adics_entera_${p.idProducto}' style='min-width:120px;'>
                                        ${adicionalesEmpresa.map(a => `<option value='${a.idAdicional}'>${a.nombreAdicional} ($${a.precioAdicional ?? 0})</option>`).join('')}
                                    </select>
                                </div>
                                <div id='adicionales_mitad_${p.idProducto}' style='display:none;'>
                                    <label style='font-size:0.9em'>Adicionales 1ra mitad:</label>
                                    <select multiple id='adics_mitad1_${p.idProducto}' style='min-width:120px;'>
                                        ${adicionalesEmpresa.map(a => `<option value='${a.idAdicional}'>${a.nombreAdicional} ($${a.precioAdicional ?? 0})</option>`).join('')}
                                    </select><br>
                                    <label style='font-size:0.9em'>Adicionales 2da mitad:</label>
                                    <select multiple id='adics_mitad2_${p.idProducto}' style='min-width:120px;'>
                                        ${adicionalesEmpresa.map(a => `<option value='${a.idAdicional}'>${a.nombreAdicional} ($${a.precioAdicional ?? 0})</option>`).join('')}
                                    </select>
                                </div>`;
                        }
                        tr = document.createElement('tr');
                        tr.innerHTML = `<td>${p.nombreProducto}</td><td>$${p.precioProducto}</td><td><input type='number' min='1' value='1' id='cant_${p.idProducto}' style='width:60px;'></td><td>${adicionalesHtml}</td><td><button class='btn' onclick='agregarProducto(${p.idProducto})'>Agregar</button></td>`;
                        tbody.appendChild(tr);
                        // Lógica para mostrar/ocultar adicionales según tipo
                        if (adicionalesEmpresa.length > 0) {
                                const tipoPizzaDiv = document.getElementById(`tipoPizza_${p.idProducto}`);
                                tipoPizzaDiv.querySelectorAll('input[type=radio]').forEach(radio => {
                                        radio.addEventListener('change', function() {
                                                if (this.value === 'entera') {
                                                        document.getElementById(`adicionales_entera_${p.idProducto}`).style.display = '';
                                                        document.getElementById(`adicionales_mitad_${p.idProducto}`).style.display = 'none';
                                                } else {
                                                        document.getElementById(`adicionales_entera_${p.idProducto}`).style.display = 'none';
                                                        document.getElementById(`adicionales_mitad_${p.idProducto}`).style.display = '';
                                                }
                                        });
                                });
                        }
                });
    }
    // Agregar producto al detalle
    window.agregarProducto = function(idProducto) {
        const prod = productosEmpresa.find(p => p.idProducto === idProducto);
        const cantidad = parseInt(document.getElementById('cant_' + idProducto).value);
        if (!prod || cantidad < 1) return;
        // Determinar si es entera o mitad
        let tipo = 'entera';
        const tipoPizzaDiv = document.getElementById(`tipoPizza_${idProducto}`);
        if (tipoPizzaDiv) {
            const checked = tipoPizzaDiv.querySelector('input[type=radio]:checked');
            if (checked) tipo = checked.value;
        }
        let adicionalesSel = [];
        let mitad = 0;
        let adicionalesMitad1 = [], adicionalesMitad2 = [];
        if (tipo === 'entera') {
            const adicsSelElem = document.getElementById('adics_entera_' + idProducto);
            if (adicsSelElem) {
                adicionalesSel = Array.from(adicsSelElem.selectedOptions).map(opt => parseInt(opt.value));
            }
            mitad = 0;
        } else {
            const adicsMitad1Elem = document.getElementById('adics_mitad1_' + idProducto);
            const adicsMitad2Elem = document.getElementById('adics_mitad2_' + idProducto);
            if (adicsMitad1Elem) {
                adicionalesMitad1 = Array.from(adicsMitad1Elem.selectedOptions).map(opt => parseInt(opt.value));
            }
            if (adicsMitad2Elem) {
                adicionalesMitad2 = Array.from(adicsMitad2Elem.selectedOptions).map(opt => parseInt(opt.value));
            }
            mitad = 1; // Para identificar que es por mitades
        }
        let existente;
        if (tipo === 'entera') {
            existente = detalle.find(d => d.idProducto === idProducto && JSON.stringify(d.adicionales) === JSON.stringify(adicionalesSel) && d.mitad === 0);
            if (existente) {
                existente.cantidad += cantidad;
            } else {
                detalle.push({ idProducto, nombre: prod.nombreProducto, precio: prod.precioProducto, cantidad, adicionales: adicionalesSel, mitad: 0 });
            }
            // Sumar precio de adicionales
            let precioAdics = 0;
            adicionalesSel.forEach(idAdic => {
                const adic = adicionalesEmpresa.find(a => a.idAdicional === idAdic);
                if (adic && adic.precioAdicional) precioAdics += adic.precioAdicional;
            });
            total += (prod.precioProducto + precioAdics) * cantidad;
        } else {
            existente = detalle.find(d => d.idProducto === idProducto && JSON.stringify(d.adicionalesMitad1) === JSON.stringify(adicionalesMitad1) && JSON.stringify(d.adicionalesMitad2) === JSON.stringify(adicionalesMitad2) && d.mitad === 1);
            if (existente) {
                existente.cantidad += cantidad;
            } else {
                detalle.push({ idProducto, nombre: prod.nombreProducto, precio: prod.precioProducto, cantidad, adicionalesMitad1, adicionalesMitad2, mitad: 1 });
            }
            // Sumar precio de adicionales de ambas mitades
            let precioAdics = 0;
            adicionalesMitad1.forEach(idAdic => {
                const adic = adicionalesEmpresa.find(a => a.idAdicional === idAdic);
                if (adic && adic.precioAdicional) precioAdics += adic.precioAdicional / 2;
            });
            adicionalesMitad2.forEach(idAdic => {
                const adic = adicionalesEmpresa.find(a => a.idAdicional === idAdic);
                if (adic && adic.precioAdicional) precioAdics += adic.precioAdicional / 2;
            });
            total += (prod.precioProducto + precioAdics) * cantidad;
        }
        actualizarDetalle();
    }
    function actualizarDetalle() {
        const ul = document.getElementById('detallePedido');
        ul.innerHTML = '';
        detalle.forEach(d => {
            let adicsTxt = '';
            if (d.adicionales && d.adicionales.length > 0) {
                adicsTxt = ' + ' + d.adicionales.map(idAdic => {
                    const adic = adicionalesEmpresa.find(a => a.idAdicional === idAdic);
                    return adic ? adic.nombreAdicional : '';
                }).join(', ');
            }
            let mitadTxt = '';
            if (d.mitad === 1) mitadTxt = ' (1ra mitad)';
            else if (d.mitad === 2) mitadTxt = ' (2da mitad)';
            const li = document.createElement('li');
            // Sumar precio adicionales
            let precioAdics = 0;
            if (d.adicionales && d.adicionales.length > 0) {
                d.adicionales.forEach(idAdic => {
                    const adic = adicionalesEmpresa.find(a => a.idAdicional === idAdic);
                    if (adic && adic.precioAdicional) precioAdics += adic.precioAdicional;
                });
            }
            li.textContent = `${d.nombre}${adicsTxt}${mitadTxt} x${d.cantidad} ($${((d.precio + precioAdics) * d.cantidad).toFixed(2)})`;
            ul.appendChild(li);
        });
        document.getElementById('totalPedido').textContent = total.toFixed(2);
    }
    // Enviar pedido
    document.getElementById('formFinalizarPedido').onsubmit = async function(e) {
        e.preventDefault();
        const mensaje = document.getElementById('respuestaPedido');
        mensaje.style.color = '';
        if (!idCliente) {
            mensaje.textContent = 'Debes iniciar sesión como cliente.';
            mensaje.style.color = 'red';
            return;
        }
        if (detalle.length === 0) {
            mensaje.textContent = 'Agrega al menos un producto al pedido.';
            mensaje.style.color = 'red';
            return;
        }
        const idEmpresa = document.getElementById('empresaSelect').value;
        const metodoPago = document.getElementById('metodoPago').value;
        const tipoEntrega = document.getElementById('tipoEntrega').value;
        const idDireccionCliente = document.getElementById('idDireccionCliente').value || null;
        // Construir detalles con adicionales estructurados
        const detalles = detalle.map(d => {
            if (d.mitad === 1) {
                // Pizza por mitades
                return {
                    idProducto: d.idProducto,
                    cantidad: d.cantidad,
                    precioUnitario: d.precio,
                    mitad: 1,
                    adicionales: [
                        ...(d.adicionalesMitad1 || []).map(id => ({ idAdicional: id, mitad: 1 })),
                        ...(d.adicionalesMitad2 || []).map(id => ({ idAdicional: id, mitad: 2 }))
                    ]
                };
            } else {
                // Pizza entera
                return {
                    idProducto: d.idProducto,
                    cantidad: d.cantidad,
                    precioUnitario: d.precio,
                    mitad: 0,
                    adicionales: (d.adicionales || []).map(id => ({ idAdicional: id, mitad: 0 }))
                };
            }
        });
        const data = {
            idCliente,
            idEmpresa,
            metodoPago,
            tipoEntrega,
            idDireccionCliente,
            detalles
        };
        try {
            const res = await fetch('http://localhost:5012/api/pedido', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) {
                const error = await res.text();
                mensaje.textContent = 'Error: ' + error;
                mensaje.style.color = 'red';
                return;
            }
            const respuesta = await res.json();
            mensaje.innerHTML = `<span style='color:green'>¡Pedido realizado con éxito!<br>Número de pedido: <b>${respuesta.idPedido ?? '(desconocido)'}</b></span><br>`;
            if (respuesta.idPedido) {
                mensaje.innerHTML += `<a href='pedidos-cliente.html' style='color:#217dbb;text-decoration:underline;'>Ver mis pedidos</a>`;
            }
            // Limpiar detalle
            detalle = [];
            total = 0;
            actualizarDetalle();
        } catch (err) {
            mensaje.textContent = 'Error inesperado al enviar el pedido.';
            mensaje.style.color = 'red';
        }
    };
    // Inicializar
    cargarEmpresas();
</script>
</body>
</html>
